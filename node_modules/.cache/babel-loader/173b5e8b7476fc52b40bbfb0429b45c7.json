{"ast":null,"code":"import { AvatarSetType } from '../../../../avatar/enum/AvatarSetType';\nimport { RoomObjectVariable } from '../../RoomObjectVariable';\nimport { FurnitureMannequinVisualizationData } from './FurnitureMannequinVisualizationData';\nimport { FurnitureVisualization } from './FurnitureVisualization';\nexport class FurnitureMannequinVisualization extends FurnitureVisualization {\n  constructor() {\n    super();\n    this._data = void 0;\n    this._mannequinScale = void 0;\n    this._figure = void 0;\n    this._gender = void 0;\n    this._dynamicAssetName = void 0;\n    this._needsUpdate = void 0;\n    this._placeHolderFigure = void 0;\n    this._disposed = void 0;\n    this._mannequinScale = -1;\n    this._figure = null;\n    this._gender = null;\n    this._dynamicAssetName = null;\n    this._needsUpdate = false;\n    this._placeHolderFigure = 'hd-99999-99998';\n    this._disposed = false;\n  }\n\n  initialize(data) {\n    if (!(data instanceof FurnitureMannequinVisualizationData)) return false;\n    return super.initialize(data);\n  }\n\n  dispose() {\n    if (this._disposed) return;\n    this._disposed = true;\n\n    if (this._dynamicAssetName && this.asset) {\n      this.asset.disposeAsset(this._dynamicAssetName);\n      this._dynamicAssetName = null;\n    }\n\n    super.dispose();\n  }\n\n  updateObject(scale, direction) {\n    const updateObject = super.updateObject(scale, direction);\n\n    if (updateObject) {\n      if (this._mannequinScale !== scale) {\n        this._mannequinScale = scale;\n        this.updateAvatar();\n      }\n    }\n\n    return updateObject;\n  }\n\n  updateModel(scale) {\n    let updateModel = super.updateModel(scale);\n\n    if (updateModel) {\n      const figure = this.object.model.getValue(RoomObjectVariable.FURNITURE_MANNEQUIN_FIGURE) || null;\n\n      if (figure) {\n        this._figure = figure + '.' + this._placeHolderFigure;\n        this._gender = this.object.model.getValue(RoomObjectVariable.FURNITURE_MANNEQUIN_GENDER) || null;\n        this.updateAvatar();\n      }\n    }\n\n    updateModel = updateModel || this._needsUpdate;\n    this._needsUpdate = false;\n    return updateModel;\n  }\n\n  updateAvatar() {\n    let forceUpdate = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n\n    if (!this.avatarExists() || forceUpdate) {\n      const avatarImage = this._data.createAvatarImage(this._figure, this._mannequinScale, this._gender, this);\n\n      if (avatarImage) {\n        avatarImage.setDirection(AvatarSetType.FULL, this.direction);\n        if (this._dynamicAssetName) this.asset.disposeAsset(this._dynamicAssetName);\n        this.asset.addAsset(this.getAvatarAssetName(), avatarImage.getImage(AvatarSetType.FULL, false, 1, false), true);\n        this._dynamicAssetName = this.getAvatarAssetName();\n        this._needsUpdate = true;\n        avatarImage.dispose();\n      }\n    }\n  }\n\n  avatarExists() {\n    return this._figure && this.getAsset(this.getAvatarAssetName()) !== null;\n  }\n\n  getAvatarAssetName() {\n    return 'mannequin_' + this._figure + '_' + this._mannequinScale + '_' + this.direction + '_' + this.object.id;\n  }\n\n  resetFigure(figure) {\n    if (figure === this._figure) this.updateAvatar(true);\n  }\n\n  getSpriteAssetName(scale, layerId) {\n    const tag = this.getLayerTag(scale, this.direction, layerId);\n\n    if (this._figure && tag === FurnitureMannequinVisualization.AVATAR_IMAGE_SPRITE_TAG && this.avatarExists()) {\n      return this.getAvatarAssetName();\n    }\n\n    return super.getSpriteAssetName(scale, layerId);\n  }\n\n  getLayerXOffset(scale, direction, layerId) {\n    const tag = this.getLayerTag(scale, direction, layerId);\n    if (tag === FurnitureMannequinVisualization.AVATAR_IMAGE_SPRITE_TAG && this.avatarExists()) return -this.getSprite(layerId).width / 2;\n    return super.getLayerXOffset(scale, direction, layerId);\n  }\n\n  getLayerYOffset(scale, direction, layerId) {\n    const tag = this.getLayerTag(scale, direction, layerId);\n    if (tag === FurnitureMannequinVisualization.AVATAR_IMAGE_SPRITE_TAG && this.avatarExists()) return -this.getSprite(layerId).height;\n    return super.getLayerYOffset(scale, direction, layerId);\n  }\n\n  get disposed() {\n    return this._disposed;\n  }\n\n}\nFurnitureMannequinVisualization.AVATAR_IMAGE_SPRITE_TAG = 'avatar_image';","map":{"version":3,"sources":["/var/www/game.bobba.ca/node_modules/@nitrots/nitro-renderer/src/nitro/room/object/visualization/furniture/FurnitureMannequinVisualization.ts"],"names":["AvatarSetType","RoomObjectVariable","FurnitureMannequinVisualizationData","FurnitureVisualization","FurnitureMannequinVisualization","constructor","_data","_mannequinScale","_figure","_gender","_dynamicAssetName","_needsUpdate","_placeHolderFigure","_disposed","initialize","data","dispose","asset","disposeAsset","updateObject","scale","direction","updateAvatar","updateModel","figure","object","model","getValue","FURNITURE_MANNEQUIN_FIGURE","FURNITURE_MANNEQUIN_GENDER","forceUpdate","avatarExists","avatarImage","createAvatarImage","setDirection","FULL","addAsset","getAvatarAssetName","getImage","getAsset","id","resetFigure","getSpriteAssetName","layerId","tag","getLayerTag","AVATAR_IMAGE_SPRITE_TAG","getLayerXOffset","getSprite","width","getLayerYOffset","height","disposed"],"mappings":"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","sourcesContent":["import { IObjectVisualizationData } from '../../../../../room/object/visualization/IRoomObjectVisualizationData';\r\nimport { AvatarSetType } from '../../../../avatar/enum/AvatarSetType';\r\nimport { IAvatarImageListener } from '../../../../avatar/IAvatarImageListener';\r\nimport { RoomObjectVariable } from '../../RoomObjectVariable';\r\nimport { FurnitureMannequinVisualizationData } from './FurnitureMannequinVisualizationData';\r\nimport { FurnitureVisualization } from './FurnitureVisualization';\r\n\r\nexport class FurnitureMannequinVisualization extends FurnitureVisualization implements IAvatarImageListener\r\n{\r\n    private static AVATAR_IMAGE_SPRITE_TAG: string = 'avatar_image';\r\n\r\n    protected _data: FurnitureMannequinVisualizationData;\r\n\r\n    private _mannequinScale: number;\r\n    private _figure: string;\r\n    private _gender: string;\r\n    private _dynamicAssetName: string;\r\n    private _needsUpdate: boolean;\r\n\r\n    private _placeHolderFigure: string;\r\n\r\n    private _disposed: boolean;\r\n\r\n    constructor()\r\n    {\r\n        super();\r\n\r\n        this._mannequinScale = -1;\r\n        this._figure = null;\r\n        this._gender = null;\r\n        this._dynamicAssetName = null;\r\n        this._needsUpdate = false;\r\n\r\n        this._placeHolderFigure = 'hd-99999-99998';\r\n\r\n        this._disposed = false;\r\n    }\r\n\r\n    public initialize(data: IObjectVisualizationData): boolean\r\n    {\r\n        if(!(data instanceof FurnitureMannequinVisualizationData)) return false;\r\n\r\n        return super.initialize(data);\r\n    }\r\n\r\n    public dispose(): void\r\n    {\r\n        if(this._disposed) return;\r\n\r\n        this._disposed = true;\r\n\r\n        if(this._dynamicAssetName && this.asset)\r\n        {\r\n            this.asset.disposeAsset(this._dynamicAssetName);\r\n\r\n            this._dynamicAssetName = null;\r\n        }\r\n\r\n        super.dispose();\r\n    }\r\n\r\n    protected updateObject(scale: number, direction: number): boolean\r\n    {\r\n        const updateObject = super.updateObject(scale, direction);\r\n\r\n        if(updateObject)\r\n        {\r\n            if(this._mannequinScale !== scale)\r\n            {\r\n                this._mannequinScale = scale;\r\n\r\n                this.updateAvatar();\r\n            }\r\n        }\r\n\r\n        return updateObject;\r\n    }\r\n\r\n    protected updateModel(scale: number): boolean\r\n    {\r\n        let updateModel = super.updateModel(scale);\r\n\r\n        if(updateModel)\r\n        {\r\n            const figure = (this.object.model.getValue<string>(RoomObjectVariable.FURNITURE_MANNEQUIN_FIGURE) || null);\r\n\r\n            if(figure)\r\n            {\r\n                this._figure = (figure + '.' + this._placeHolderFigure);\r\n                this._gender = (this.object.model.getValue<string>(RoomObjectVariable.FURNITURE_MANNEQUIN_GENDER) || null);\r\n\r\n                this.updateAvatar();\r\n            }\r\n        }\r\n\r\n        updateModel = (updateModel || this._needsUpdate);\r\n\r\n        this._needsUpdate = false;\r\n\r\n        return updateModel;\r\n    }\r\n\r\n    private updateAvatar(forceUpdate: boolean = false): void\r\n    {\r\n        if(!this.avatarExists() || forceUpdate)\r\n        {\r\n            const avatarImage = this._data.createAvatarImage(this._figure, this._mannequinScale, this._gender, this);\r\n\r\n            if(avatarImage)\r\n            {\r\n                avatarImage.setDirection(AvatarSetType.FULL, this.direction);\r\n\r\n                if(this._dynamicAssetName) this.asset.disposeAsset(this._dynamicAssetName);\r\n\r\n                this.asset.addAsset(this.getAvatarAssetName(), avatarImage.getImage(AvatarSetType.FULL, false, 1, false), true);\r\n\r\n                this._dynamicAssetName = this.getAvatarAssetName();\r\n                this._needsUpdate = true;\r\n\r\n                avatarImage.dispose();\r\n            }\r\n        }\r\n    }\r\n\r\n    private avatarExists(): boolean\r\n    {\r\n        return (this._figure && (this.getAsset(this.getAvatarAssetName()) !== null));\r\n    }\r\n\r\n    private getAvatarAssetName(): string\r\n    {\r\n        return (((((('mannequin_' + this._figure) + '_') + this._mannequinScale) + '_') + this.direction) + '_') + this.object.id;\r\n    }\r\n\r\n    public resetFigure(figure: string): void\r\n    {\r\n        if(figure === this._figure) this.updateAvatar(true);\r\n    }\r\n\r\n    protected getSpriteAssetName(scale: number, layerId: number): string\r\n    {\r\n        const tag = this.getLayerTag(scale, this.direction, layerId);\r\n\r\n        if(this._figure && (tag === FurnitureMannequinVisualization.AVATAR_IMAGE_SPRITE_TAG) && this.avatarExists())\r\n        {\r\n            return this.getAvatarAssetName();\r\n        }\r\n\r\n        return super.getSpriteAssetName(scale, layerId);\r\n    }\r\n\r\n    protected getLayerXOffset(scale: number, direction: number, layerId: number): number\r\n    {\r\n        const tag = this.getLayerTag(scale, direction, layerId);\r\n\r\n        if((tag === FurnitureMannequinVisualization.AVATAR_IMAGE_SPRITE_TAG) && this.avatarExists()) return (-(this.getSprite(layerId).width) / 2);\r\n\r\n        return super.getLayerXOffset(scale, direction, layerId);\r\n    }\r\n\r\n    protected getLayerYOffset(scale: number, direction: number, layerId: number): number\r\n    {\r\n        const tag = this.getLayerTag(scale, direction, layerId);\r\n\r\n        if((tag === FurnitureMannequinVisualization.AVATAR_IMAGE_SPRITE_TAG) && this.avatarExists()) return -(this.getSprite(layerId).height);\r\n\r\n        return super.getLayerYOffset(scale, direction, layerId);\r\n    }\r\n\r\n    public get disposed(): boolean\r\n    {\r\n        return this._disposed;\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}